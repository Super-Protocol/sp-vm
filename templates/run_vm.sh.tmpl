#!/bin/bash

set -euo pipefail;

SCRIPT_DIR="$( cd "$( dirname "$0" )" && pwd )";

if [[ ! -f "$SCRIPT_DIR/state.qcow2" ]]; then
    qemu-img create -f qcow2 state.qcow2 "$STATE_DISK_SIZE";
fi

qemu-system-x86_64 \
    -enable-kvm \
    -append "root=/dev/vda1 console=ttyS0 clearcpuid=mtrr systemd.log_level=trace systemd.log_target=log rootfs_verity.scheme=dm-verity rootfs_verity.hash=$ROOT_HASH" \
    -drive "file=$SCRIPT_DIR/rootfs.img,if=virtio,format=raw" \
    -drive "file=$SCRIPT_DIR/state.qcow2,if=virtio,format=qcow2" \
    -kernel "$SCRIPT_DIR/vmlinuz" \
    -smp "cores=$VM_CPU" \
    -m "$VM_MEMORY" \
    -cpu host \
    -object '{"qom-type":"tdx-guest","id":"tdx","quote-generation-socket":{"type": "vsock", "cid":"2","port":"4050"}}' \
    -netdev "user,id=n1,ipv6=off,hostfwd=tcp:127.0.0.1:2222-:22" \
    -device "virtio-net-pci,netdev=n1" \
    -nographic \
    -object "memry-backend-ram,id=mem0,size=$VM_MEMORY" \
    -machine "q35,kernel-irqchip=split,confidential-guest-support=tdx,memory-backend=mem0" \
    -bios "$SCRIPT_DIR/OVMF.fd" \
    -vga "none" \
    -nodefaults \
    -serial "stdio" \
    -object "iommufd,id=iommufd0" \
    -device "pcie-root-port,id=pci.1,bus=pcie.0" \
    -device "vfio-pci,host=2a:00.0,bus=pci.1,iommufd=iommufd0" \
    -fw_cfg "name=opt/ovmf/X-PciMmio64,string=262144" \
    -device "vhost-vsock-pci,guest-cid=3" \
    -fsdev "local,security_model=passthrough,id=fsdev0,path=${SCRIPT_DIR}/config" \
    -device "virtio-9p-pci,fsdev=fsdev0,mount_tag=sharedfolder";
