name: swarm-cloud-api
version: 1.0.0
commands:
  - init
  - apply
  - health
  - finalize
  - destroy
healthcheckIntervalSecs: 60
entrypoint: main.py
stateExpr:
  engine: jq
  query: |
    ($swarmdb.clusters[] | select(.id == "{{ clusterId }}" and .deleted_ts == null)) as $cluster |

    ([$swarmdb.clusternodes[] | select(.cluster == "{{ clusterId }}" and .deleted_ts == null)]) as $apiClusterNodes |

    ($apiClusterNodes | map(.node)) as $apiNodeIds |

    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "wireguard" and .deleted_ts == null) |
      select(
        (
          [$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($apiNodeIds[])))] |
          length > 0
        )
      )
    ) as $wgCluster |

    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "cockroachdb" and .deleted_ts == null)
    ) as $cockroachCluster |

    ([$swarmdb.clusternodes[] | select(.cluster == $cockroachCluster.id and .deleted_ts == null)]) as $cockroachClusterNodes |

    ($cockroachClusterNodes | map(.node)) as $cockroachNodeIds |

    # Find Knot DNS cluster
    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "knot" and .deleted_ts == null)
    ) as $knotCluster |

    ([$swarmdb.clusternodes[] | select(.cluster == $knotCluster.id and .deleted_ts == null)]) as $knotClusterNodes |

    ($knotClusterNodes | map(.node)) as $knotNodeIds |

    {
      cluster: {
        id: $cluster.id,
        cluster_policy: $cluster.cluster_policy,
        leader_node: $cluster.leader_node
      },

      clusterNodes: [
        $apiClusterNodes[] |
        {id, node_id: .node, cluster}
      ] | sort_by(.id, .node_id, .cluster),

      apiNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith("{{ clusterId }}:")) and
          .deleted_ts == null and
          (.name | startswith("swarm_cloud_api_"))
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      wgCluster: {
        id: $wgCluster.id
      },

      wgNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith($wgCluster.id)) and
          .deleted_ts == null and
          .name == "tunnel_ip"
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      cockroachCluster: {
        id: $cockroachCluster.id
      },

      cockroachClusterNodes: [
        $cockroachClusterNodes[] |
        {id, node_id: .node, cluster}
      ] | sort_by(.id, .node_id, .cluster),

      cockroachNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith($cockroachCluster.id)) and
          .deleted_ts == null and
          .name == "cockroachdb_node_ready"
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      knotCluster: {
        id: $knotCluster.id
      },

      knotNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith($knotCluster.id)) and
          .deleted_ts == null and
          .name == "knot_node_ready"
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      knotClusterProperties: [
        $swarmdb.clusterproperties[] |
        select(
          .cluster == $knotCluster.id and
          .deleted_ts == null and
          (.name | startswith("knot_tsig_"))
        ) |
        {cluster, name, value}
      ] | sort_by(.cluster, .name, .value),

      clusterProperties: [
        $swarmdb.clusterproperties[] |
        select(
          .cluster == "{{ clusterId }}" and
          .deleted_ts == null and
          (.name | startswith("swarm_cloud_api_"))
        ) |
        {cluster, name, value}
      ] | sort_by(.cluster, .name, .value),

      nodeAddrs: [
        $swarmdb.nodes[] |
        select(.node_id | IN($apiNodeIds[])) |
        {node_id: .node_id, addr: .addr, port: .port}
      ] | sort_by(.node_id, .addr, .port),

      redisCluster: (
        $swarmdb.clusters[] |
        select(.cluster_policy == "redis" and .deleted_ts == null) |
        select(
          (
            [$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($apiNodeIds[])))] |
            length > 0
          )
        )
      ),

      redisNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith((
            $swarmdb.clusters[] |
            select(.cluster_policy == "redis" and .deleted_ts == null) |
            select(
              (
                [$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($apiNodeIds[])))] |
                length > 0
              )
            )
          ).id)) and
          .deleted_ts == null and
          (.name | startswith("redis_"))
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      swarmidpointer: (
        $swarmdb.swarmidpointer[] |
        select(.id == "global_id") |
        .value
      ),

      globalId: (
        $swarmdb.swarmidpointer[] |
        select(.id == "global_id") |
        .value
      ) // null,

      swarmSecrets: [
        $swarmdb.swarmsecrets[] |
        select(.id | IN("base_domain"))
      ] | sort_by(.id)
    }
