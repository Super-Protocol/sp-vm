name: test-app-route
version: 1.0.0
commands:
  - init
  - apply
  - health
  - finalize
  - destroy
healthcheckIntervalSecs: 60
entrypoint: main.py
stateExpr:
  engine: jq
  query: |
    ($swarmdb.clusters[] | select(.id == "{{ clusterId }}" and .deleted_ts == null)) as $cluster |

    ([$swarmdb.clusternodes[] | select(.cluster == "{{ clusterId }}" and .deleted_ts == null)]) as $appClusterNodes |

    ($appClusterNodes | map(.node)) as $appNodeIds |

    # Find Redis cluster with at least one ready node (not bound to app nodes)
    (
      [
        $swarmdb.clusters[] |
        select(.cluster_policy == "redis" and .deleted_ts == null) |
        . as $c |
        select(
          (
            [$swarmdb.clusternodeproperties[] |
              select(
                (.cluster_node | startswith($c.id)) and
                .deleted_ts == null and
                .name == "redis_node_ready" and
                .value == "true"
              )
            ] | length > 0
          )
        )
      ] | .[0]
    ) as $redisCluster |

    # Redis cluster nodes
    ([$swarmdb.clusternodes[] | select(.cluster == $redisCluster.id and .deleted_ts == null)]) as $redisClusterNodes |
    ($redisClusterNodes | map(.node)) as $redisNodeIds |

    # Find Redis Sentinel cluster
    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "redis-sentinel" and .deleted_ts == null)
    ) as $sentinelCluster |

    # Redis Sentinel cluster nodes
    ([$swarmdb.clusternodes[] | select(.cluster == $sentinelCluster.id and .deleted_ts == null)]) as $sentinelClusterNodes |
    ($sentinelClusterNodes | map(.node)) as $sentinelNodeIds |

    # Find WireGuard cluster that contains any Redis nodes
    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "wireguard" and .deleted_ts == null) |
      select(
        (
          [$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($redisNodeIds[])))] |
          length > 0
        )
      )
    ) as $wgCluster |

    # Find WireGuard cluster that contains any Redis Sentinel nodes
    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "wireguard" and .deleted_ts == null) |
      select(
        (
          [$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($sentinelNodeIds[])))] |
          length > 0
        )
      )
    ) as $sentinelWgCluster |

    {
      cluster: {
        id: $cluster.id,
        cluster_policy: $cluster.cluster_policy,
        leader_node: $cluster.leader_node
      },

      clusterNodes: [
        $appClusterNodes[] |
        {id, node_id: .node, cluster}
      ] | sort_by(.id, .node_id, .cluster),

      redisCluster: {
        id: $redisCluster.id
      },

      redisNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith($redisCluster.id)) and
          .deleted_ts == null and
          (.name | startswith("redis_"))
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      sentinelCluster: {
        id: $sentinelCluster.id
      },

      sentinelNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith($sentinelCluster.id)) and
          .deleted_ts == null and
          (.name | startswith("redis_sentinel_"))
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      wgCluster: {
        id: $wgCluster.id
      },

      wgNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith($wgCluster.id)) and
          .deleted_ts == null and
          .name == "tunnel_ip"
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      sentinelWgNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith($sentinelWgCluster.id)) and
          .deleted_ts == null and
          .name == "tunnel_ip"
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id)
    }
