name: latency-measurement
version: 1.0.0
commands:
  - apply
  - health
  - destroy
healthcheckIntervalSecs: 30
entrypoint: main.py
stateExpr:
  engine: jq
  query: |
    ([$swarmdb.clusternodes[] | select(.cluster == "{{ clusterId }}" and .deleted_ts == null)]) as $measurementClusterNodes |

    ($measurementClusterNodes | map(.node)) as $measurementNodeIds |

    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "wireguard" and .deleted_ts == null) |
      select(
        (
          [$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($measurementNodeIds[])))] |
          length > 0
        )
      )
    ) as $wgCluster |

    {
      wgCluster: {
        id: $wgCluster.id
      },

      wgClusterNodes: [
        $swarmdb.clusternodes[] |
        select(.cluster == $wgCluster.id and .deleted_ts == null) |
        {id, node_id: .node, cluster}
      ] | sort_by(.node_id),

      wgNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith($wgCluster.id + ":")) and
          .deleted_ts == null and
          .name == "tunnel_ip"
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name),

      measurementNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith("{{ clusterId }}:")) and
          .deleted_ts == null and
          .name == "udp_ping_port"
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name)
    }
