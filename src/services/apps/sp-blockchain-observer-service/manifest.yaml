name: sp-blockchain-observer-service
version: 1.0.0
commands:
  - init
  - apply
  - health
  - finalize
  - destroy
healthcheckIntervalSecs: 60
entrypoint: main.py
stateExpr:
  engine: jq
  query: |
    ($swarmdb.clusters[] | select(.id == "{{ clusterId }}" and .deleted_ts == null)) as $cluster |

    ([$swarmdb.clusternodes[] | select(.cluster == "{{ clusterId }}" and .deleted_ts == null)]) as $svcClusterNodes |

    ($svcClusterNodes | map(.node)) as $svcNodeIds |

    # Find a NATS cluster that shares nodes with this service cluster
    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "nats" and .deleted_ts == null) |
      select( ([$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($svcNodeIds[])))] | length) > 0 )
    ) as $natsCluster |

    # Find a MongoDB cluster that shares nodes with this service cluster
    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "mongodb" and .deleted_ts == null) |
      select( ([$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($svcNodeIds[])))] | length) > 0 )
    ) as $mongodbCluster |

    # Find a Redis cluster that shares nodes with this service cluster
    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "redis" and .deleted_ts == null) |
      select( ([$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($svcNodeIds[])))] | length) > 0 )
    ) as $redisCluster |

    # A WireGuard cluster (any) that includes our nodes; used to fetch tunnel IPs for our nodes
    (
      $swarmdb.clusters[] |
      select(.cluster_policy == "wireguard" and .deleted_ts == null) |
      select( ([$swarmdb.clusternodes[] | select(.deleted_ts == null and (.node | IN($svcNodeIds[])))] | length) > 0 )
    ) as $wgCluster |

    {
      cluster: {
        id: $cluster.id,
        cluster_policy: $cluster.cluster_policy,
        leader_node: $cluster.leader_node
      },

      clusterNodes: [
        $svcClusterNodes[] |
        {id, node_id: .node, cluster}
      ] | sort_by(.id, .node_id, .cluster),

      # Node properties for this service's nodes from the WG cluster (to get tunnel_ip per node)
      blockchainObserverServiceNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith("{{ clusterId }}:")) and
          .deleted_ts == null and
          (.name | startswith("blockchain_observer_service_"))
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      wgCluster: {
        id: $wgCluster.id
      },

      wgNodeProperties: [
        $swarmdb.clusternodeproperties[] |
        select(
          (.cluster_node | startswith($wgCluster.id)) and
          .deleted_ts == null and
          .name == "tunnel_ip"
        ) |
        {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
      ] | sort_by(.cluster_node, .name, .value, .node_id),

      # NATS related cluster and WG tunnel IPs for nodes that are part of the selected NATS cluster
      natsCluster: (
        if $natsCluster.id then { id: $natsCluster.id } else null end
      ),

      natsClusterNodes: (
        if $natsCluster.id then
          [$swarmdb.clusternodes[] | select(.cluster == $natsCluster.id and .deleted_ts == null)]
        else [] end
      ),

      natsWgNodeProperties: (
        if $natsCluster.id then
          [
            $swarmdb.clusternodeproperties[] |
            select(
              (.cluster_node | startswith($wgCluster.id)) and
              .deleted_ts == null and
              .name == "tunnel_ip"
            ) |
            {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node}
          ] | sort_by(.cluster_node, .name, .value, .node_id)
        else [] end
      ),

      # MongoDB related cluster and WG tunnel IPs for nodes that are part of the selected MongoDB cluster
      mongodbCluster: (
        if $mongodbCluster.id then { id: $mongodbCluster.id } else null end
      ),

      mongodbClusterNodes: (
        if $mongodbCluster.id then
          [$swarmdb.clusternodes[] | select(.cluster == $mongodbCluster.id and .deleted_ts == null)]
        else [] end
      ),

      mongodbWgNodeProperties: (
        if $mongodbCluster.id then
          (
            [$swarmdb.clusternodes[] | select(.cluster == $mongodbCluster.id and .deleted_ts == null)] | map(.node)
          ) as $mongodbNodeIds |
          [
            $swarmdb.clusternodeproperties[] |
            select(
              (.cluster_node | startswith($wgCluster.id)) and
              .deleted_ts == null and
              .name == "tunnel_ip"
            ) |
            {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node} |
            select(.node_id | IN($mongodbNodeIds[]))
          ] | sort_by(.cluster_node, .name, .value, .node_id)
        else [] end
      ),

      # Redis related cluster and WG tunnel IPs for nodes that are part of the selected Redis cluster
      redisCluster: (
        if $redisCluster.id then { id: $redisCluster.id } else null end
      ),

      redisClusterNodes: (
        if $redisCluster.id then
          [$swarmdb.clusternodes[] | select(.cluster == $redisCluster.id and .deleted_ts == null)]
        else [] end
      ),

      redisWgNodeProperties: (
        if $redisCluster.id then
          (
            [$swarmdb.clusternodes[] | select(.cluster == $redisCluster.id and .deleted_ts == null)] | map(.node)
          ) as $redisNodeIds |
          [
            $swarmdb.clusternodeproperties[] |
            select(
              (.cluster_node | startswith($wgCluster.id)) and
              .deleted_ts == null and
              .name == "tunnel_ip"
            ) |
            {cluster_node, name, value, node_id: ( .cluster_node as $cn | $swarmdb.clusternodes[] | select(.id == $cn)) | .node} |
            select(.node_id | IN($redisNodeIds[]))
          ] | sort_by(.cluster_node, .name, .value, .node_id)
        else [] end
      )
    }


