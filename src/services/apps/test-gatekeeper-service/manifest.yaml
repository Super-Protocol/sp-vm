name: test-gatekeeper-service
version: 1.0.0
commands:
  - init
  - apply
  - health
  - finalize
  - destroy
healthcheckIntervalSecs: 60
entrypoint: main.py
stateExpr:
  engine: jq
  query: |
    ($swarmdb.clusters[] | select(.id == "{{ clusterId }}" and .deleted_ts == null)) as $cluster |

    ([$swarmdb.clusternodes[] | select(.cluster == "{{ clusterId }}" and .deleted_ts == null)]) as $appClusterNodes |

    {
      cluster: {
        id: $cluster.id,
        cluster_policy: $cluster.cluster_policy,
        leader_node: $cluster.leader_node
      },

      clusterNodes: [
        $appClusterNodes[] |
        {id, node_id: .node, cluster}
      ] | sort_by(.id, .node_id, .cluster)
    }
